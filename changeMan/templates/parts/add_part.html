{% extends 'base.html' %}
{% block content %}
{% if user.is_authenticated %}
{% load static %}

<body>
	<label for="part-type">Part Type: </label>
		<select id="part-type">
		</select><br>
	<label for="pn-start">Part Number Family: </label>
		<select id="pn-start">
		</select><br>
	<label for="pn-mid">Part Number Sub-Type</label>
		<select id="pn-mid">
		</select><br>

	<p id="cap"></p>

	<form id="part-number-frm" method="POST">
		{% csrf_token %}
		{{ form.as_p }}
		<button type="submit">Add Part</button>
	</form>

	<button id="btn-next-pn">Get Next Part Number</button>

</body>
<script>
		var pnType = document.getElementById("part-type");
		var request = new XMLHttpRequest();
		var pnCap = document.getElementById("pn-start");
		var pnMid = document.getElementById("pn-mid");
		var btnGet = document.getElementById("btn-next-pn");
		var capTxt = document.getElementById("cap");

		document.getElementById("id_part_number").disabled = true;


		function addOption(optValue, optTxt, selectElem){
			var option = document.createElement("option");
			var optionTxt = document.createTextNode(optTxt);
			option.appendChild(optionTxt);
			option.value = optValue;
			selectElem.appendChild(option);

		}

		function updatePNText(){
			var first = pnCap.options[pnCap.selectedIndex].value
			var mid = pnMid.options[pnMid.selectedIndex].value
			var pn_txt = document.getElementById("id_part_number");
			capTxt.innerHTML = '';
			capTxt.innerHTML = first + '-' + mid + '-'
			var partial_pn = document.getElementById("cap").innerHTML;
			pn_txt.value = partial_pn;
		}
		
		request.onload = function () {
			if (request.status >= 200 && request.status < 300){
				var liftData = JSON.parse(request.responseText);
				for(let i = 0; i < liftData.Lifts.length; i++){
					addOption(liftData.Lifts[i], liftData.Lifts[i], pnType);
				}

				var data = pnType.options[pnType.selectedIndex].text;
				pnCap.options.length = 0;
				pnMid.options.length = 0;
				for(let j = 0; j < liftData[data].length; j++){
					addOption(liftData[data][j][0], liftData[data][j][1], pnCap);
				}

				for(let k = 0; k < liftData[data + "-Type"].length; k++){
					addOption(liftData[data + "-Type"][k][0], liftData[data + "-Type"][k][1], pnMid)
				}

				updatePNText()

				pnType.onchange = function () {
					var data = pnType.options[pnType.selectedIndex].text;
					pnCap.options.length = 0;
					pnMid.options.length = 0;
					for(let j = 0; j < liftData[data].length; j++){
						addOption(liftData[data][j][0], liftData[data][j][1], pnCap);
					}

					for(let k = 0; k < liftData[data + "-Type"].length; k++){
						addOption(liftData[data + "-Type"][k][0], liftData[data + "-Type"][k][1], pnMid)
					}

					updatePNText()
				}


				pnCap.onchange = function() {
					updatePNText();
				}

				pnMid.onchange = function() {
					updatePNText()
				}

			}
			
		
		}


		request.open("GET", "{{ STATIC_URL }}/static/javascript/part_number_data.json");
		request.send();

		btnGet.onclick = function() {
			
			
			var FD = new FormData(document.getElementById('part-number-frm'));
			
			var part_request = new XMLHttpRequest();

			part_request.onload = function(){
				var pn_txt = document.getElementById("id_part_number");
				capTxt.innerHTML = "";
				capTxt.innerHTML = part_request.response;
				pn_txt.value = "";
				pn_txt.value = part_request.response;
				//console.log(part_request.response);
			}

			part_request.onerror = function(){
				alert('Unknown Problem');
			}

			part_request.open('POST', '/parts/spRequest/');
			part_request.send(FD);
		}

</script>

 {% else %}
  {% include 'redirect.html' %}
 {% endif %}
{% endblock %}